# Gem Knowledge Viewer ‚Äî Design Document

## Overview

This design adds a read-only viewer for gem knowledge files (`.md` subfiles generated by the knowledge store). It consists of two parts: a **file tree** in the gem detail panel showing which files exist, and a **tabbed viewer** in the right panel that opens files in tabs beside the detail view.

The design follows the existing recording tab pattern exactly ‚Äî when a user clicks a knowledge file, RightPanel switches from single-panel to tabbed mode, just like recordings switch from single detail to Details + Chat tabs when a chat session starts.

### Design Goals

1. **Visibility**: Users can see what knowledge files exist for any gem and inspect their contents
2. **Familiar UX**: Tab system mirrors the recording view ‚Äî no new interaction patterns to learn
3. **Non-intrusive**: Default behavior is unchanged. File tree is below existing content. Tabs only appear when a file is opened
4. **Minimal backend work**: Only one new Tauri command. All data types and backend methods already exist

### Key Design Decisions

- **File tree in GemDetailPanel, tabs in RightPanel**: Separation of concerns ‚Äî detail panel lists files, right panel manages the tab lifecycle
- **Raw markdown display**: Show `.md` source as preformatted monospace text, not rendered HTML. This is a developer/debug tool
- **Lazy fetching**: File content loaded on tab click, cached in memory. No upfront loading of all files
- **Closeable tabs**: Each file tab has an X. Closing all returns to single-panel mode
- **No new dependencies**: Raw text display in a `<pre>` block. No markdown renderer needed

---

## Architecture

### Component Hierarchy

```
App.tsx
  ‚îî‚îÄ‚îÄ RightPanel.tsx (gems section)
        ‚îú‚îÄ‚îÄ [Tab Bar]  ‚Üê NEW: "Detail" + open file tabs (only when files are open)
        ‚îú‚îÄ‚îÄ GemDetailPanel.tsx
        ‚îÇ     ‚îú‚îÄ‚îÄ ... existing content ...
        ‚îÇ     ‚îî‚îÄ‚îÄ KnowledgeFileTree  ‚Üê NEW: file list section
        ‚îî‚îÄ‚îÄ KnowledgeFileViewer  ‚Üê NEW: file content display (one per open tab)
```

### State Management

All viewer state lives in `RightPanel`. `GemDetailPanel` is stateless with respect to tabs ‚Äî it just fires a callback.

```
RightPanel state (gems section):
  openKnowledgeFiles: string[]                    // ["gem.md", "enrichment.md"]
  activeGemTab: 'detail' | string                 // 'detail' or a filename
  knowledgeFileContents: Record<string, string>   // { "gem.md": "# Title\n...", ... }

GemDetailPanel state (new):
  knowledgeEntry: KnowledgeEntry | null           // subfile metadata from get_gem_knowledge

GemDetailPanel props (new):
  onOpenKnowledgeFile: (filename: string) => void // callback to RightPanel
```

### Data Flow

```
1. GemDetailPanel mounts
   ‚îú‚îÄ‚îÄ invoke('get_gem', { id: gemId })           ‚Üê existing
   ‚îî‚îÄ‚îÄ invoke('get_gem_knowledge', { gemId })     ‚Üê NEW (parallel)
         ‚Üí KnowledgeEntry { subfiles: [...], assembled, version, last_assembled }

2. User clicks "enrichment.md" in file tree
   ‚îî‚îÄ‚îÄ GemDetailPanel calls props.onOpenKnowledgeFile("enrichment.md")
         ‚îî‚îÄ‚îÄ RightPanel.handleOpenKnowledgeFile("enrichment.md")
               ‚îú‚îÄ‚îÄ Adds "enrichment.md" to openKnowledgeFiles (if not already)
               ‚îú‚îÄ‚îÄ Sets activeGemTab = "enrichment.md"
               ‚îî‚îÄ‚îÄ Fetches content (if not cached):
                     invoke('get_gem_knowledge_subfile', { gemId, filename: "enrichment.md" })
                       ‚Üí "## Summary\n\nA guide to...\n\n## Tags\n\n- react\n..."
                       ‚Üí Stored in knowledgeFileContents["enrichment.md"]

3. User clicks X on "enrichment.md" tab
   ‚îî‚îÄ‚îÄ RightPanel removes from openKnowledgeFiles
         ‚îú‚îÄ‚îÄ If other tabs open ‚Üí switch to last remaining tab
         ‚îî‚îÄ‚îÄ If no tabs left ‚Üí activeGemTab = 'detail', tab bar hidden

4. User selects a different gem
   ‚îî‚îÄ‚îÄ RightPanel resets: openKnowledgeFiles = [], activeGemTab = 'detail'
```

---

## Backend Changes

### New Tauri Command

One new command in `src/knowledge/commands.rs`:

```rust
#[tauri::command]
pub async fn get_gem_knowledge_subfile(
    gem_id: String,
    filename: String,
    knowledge_store: State<'_, Arc<dyn KnowledgeStore>>,
) -> Result<Option<String>, String> {
    knowledge_store.get_subfile(&gem_id, &filename).await
}
```

Register in `lib.rs` `generate_handler![]`:
```rust
knowledge::commands::get_gem_knowledge_subfile,
```

No other backend changes needed. `KnowledgeStore::get_subfile()` and `get()` already exist and work.

---

## Frontend Changes

### TypeScript Types

Add to `src/state/types.ts` (or a new `src/state/knowledge-types.ts`):

```typescript
interface KnowledgeSubfile {
  filename: string;
  exists: boolean;
  size_bytes: number;
  last_modified: string | null;
}

interface KnowledgeEntry {
  gem_id: string;
  assembled: string;
  subfiles: KnowledgeSubfile[];
  version: number;
  last_assembled: string;
}
```

### GemDetailPanel.tsx Changes

**New state:**
```typescript
const [knowledgeEntry, setKnowledgeEntry] = useState<KnowledgeEntry | null>(null);
```

**New prop:**
```typescript
interface GemDetailPanelProps {
  // ... existing props ...
  onOpenKnowledgeFile: (filename: string) => void;
}
```

**Fetch on mount** (parallel with existing `get_gem`):
```typescript
useEffect(() => {
  loadGem();
  loadKnowledge();
}, [gemId]);

const loadKnowledge = async () => {
  try {
    const entry = await invoke<KnowledgeEntry | null>('get_gem_knowledge', { gemId });
    setKnowledgeEntry(entry);
  } catch {
    // Silent fail ‚Äî knowledge viewer is optional
    setKnowledgeEntry(null);
  }
};
```

**File tree section** (after transcript, before actions):
```tsx
{knowledgeEntry && (
  <div className="knowledge-file-tree">
    <h4>Knowledge Files</h4>
    {knowledgeEntry.subfiles
      .filter(s => s.exists && s.filename !== 'meta.json')
      .map(subfile => (
        <div
          key={subfile.filename}
          className="knowledge-file-row"
          onClick={() => onOpenKnowledgeFile(subfile.filename)}
        >
          <span className="file-icon">üìÑ</span>
          <span className="file-name">{subfile.filename}</span>
          <span className="file-size">{formatFileSize(subfile.size_bytes)}</span>
        </div>
      ))
    }
  </div>
)}
```

**No knowledge files state:**
```tsx
{knowledgeEntry && knowledgeEntry.subfiles.filter(s => s.exists).length <= 1 && (
  <div className="knowledge-file-tree">
    <h4>Knowledge Files</h4>
    <div className="no-knowledge-files">
      <span>No knowledge files</span>
      <button onClick={handleRegenerate} className="action-button">Generate</button>
    </div>
  </div>
)}
```

### RightPanel.tsx Changes (gems section)

Replace the current gems block (lines 265-287) with tabbed logic:

```tsx
// Gems nav
if (activeNav === 'gems') {
  if (selectedGemId) {
    // Tabbed mode: when knowledge files are open
    if (openKnowledgeFiles.length > 0) {
      return (
        <div className="right-panel" style={style}>
          <div className="record-tabs-view">
            <div className="tab-buttons">
              <button
                className={`tab-button ${activeGemTab === 'detail' ? 'active' : ''}`}
                onClick={() => setActiveGemTab('detail')}
              >
                Detail
              </button>
              {openKnowledgeFiles.map(filename => (
                <button
                  key={filename}
                  className={`tab-button ${activeGemTab === filename ? 'active' : ''}`}
                  onClick={() => setActiveGemTab(filename)}
                >
                  {filename}
                  <span
                    className="tab-close"
                    onClick={(e) => { e.stopPropagation(); handleCloseTab(filename); }}
                  >
                    √ó
                  </span>
                </button>
              ))}
            </div>
            <div className="tab-content">
              {activeGemTab === 'detail' ? (
                <GemDetailPanel
                  gemId={selectedGemId}
                  onDelete={onDeleteGem}
                  onTranscribe={onTranscribeGem}
                  onEnrich={onEnrichGem}
                  aiAvailable={aiAvailable}
                  onOpenKnowledgeFile={handleOpenKnowledgeFile}
                />
              ) : (
                <KnowledgeFileViewer
                  content={knowledgeFileContents[activeGemTab]}
                  filename={activeGemTab}
                  loading={!knowledgeFileContents[activeGemTab]}
                />
              )}
            </div>
          </div>
        </div>
      );
    }

    // Single-panel mode: no knowledge files open (current behavior)
    return (
      <div className="right-panel" style={style}>
        <GemDetailPanel
          gemId={selectedGemId}
          onDelete={onDeleteGem}
          onTranscribe={onTranscribeGem}
          onEnrich={onEnrichGem}
          aiAvailable={aiAvailable}
          onOpenKnowledgeFile={handleOpenKnowledgeFile}
        />
      </div>
    );
  }

  return (
    <div className="right-panel" style={style}>
      <div className="right-panel-placeholder">
        Select a gem to view details
      </div>
    </div>
  );
}
```

**Handler functions in RightPanel:**

```typescript
const handleOpenKnowledgeFile = async (filename: string) => {
  // Add tab if not already open
  if (!openKnowledgeFiles.includes(filename)) {
    setOpenKnowledgeFiles(prev => [...prev, filename]);
  }
  setActiveGemTab(filename);

  // Fetch content if not cached
  if (!knowledgeFileContents[filename] && selectedGemId) {
    try {
      const content = await invoke<string | null>(
        'get_gem_knowledge_subfile',
        { gemId: selectedGemId, filename }
      );
      setKnowledgeFileContents(prev => ({
        ...prev,
        [filename]: content ?? 'File not found'
      }));
    } catch (e) {
      setKnowledgeFileContents(prev => ({
        ...prev,
        [filename]: `Error loading file: ${e}`
      }));
    }
  }
};

const handleCloseTab = (filename: string) => {
  setOpenKnowledgeFiles(prev => prev.filter(f => f !== filename));
  // If closing the active tab, switch to detail or last open tab
  if (activeGemTab === filename) {
    const remaining = openKnowledgeFiles.filter(f => f !== filename);
    setActiveGemTab(remaining.length > 0 ? remaining[remaining.length - 1] : 'detail');
  }
  // Clean up cached content
  setKnowledgeFileContents(prev => {
    const next = { ...prev };
    delete next[filename];
    return next;
  });
};
```

**Reset on gem change:**
```typescript
useEffect(() => {
  setOpenKnowledgeFiles([]);
  setActiveGemTab('detail');
  setKnowledgeFileContents({});
}, [selectedGemId]);
```

### KnowledgeFileViewer Component

A simple inline component (or can be defined in RightPanel directly):

```tsx
function KnowledgeFileViewer({ content, filename, loading }: {
  content?: string;
  filename: string;
  loading: boolean;
}) {
  if (loading) {
    return <div className="knowledge-file-viewer loading">Loading {filename}...</div>;
  }
  return (
    <div className="knowledge-file-viewer">
      <pre className="knowledge-file-content">{content}</pre>
    </div>
  );
}
```

---

## CSS Additions

Add to `App.css`:

```css
/* Knowledge File Tree (in GemDetailPanel) */
.knowledge-file-tree {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color, #333);
}

.knowledge-file-tree h4 {
  font-size: 13px;
  color: var(--text-secondary, #888);
  margin-bottom: 8px;
}

.knowledge-file-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
}

.knowledge-file-row:hover {
  background: var(--hover-bg, rgba(255, 255, 255, 0.05));
}

.knowledge-file-row .file-icon {
  font-size: 14px;
  flex-shrink: 0;
}

.knowledge-file-row .file-name {
  flex: 1;
  font-family: 'SF Mono', Menlo, monospace;
  font-size: 12px;
}

.knowledge-file-row .file-size {
  color: var(--text-muted, #666);
  font-size: 11px;
  flex-shrink: 0;
}

.no-knowledge-files {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px;
  color: var(--text-muted, #666);
  font-size: 13px;
}

/* Tab close button */
.tab-button .tab-close {
  margin-left: 6px;
  font-size: 14px;
  opacity: 0.5;
  line-height: 1;
}

.tab-button .tab-close:hover {
  opacity: 1;
}

/* Knowledge File Viewer */
.knowledge-file-viewer {
  height: 100%;
  overflow-y: auto;
  padding: 16px;
}

.knowledge-file-viewer.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted, #666);
}

.knowledge-file-content {
  font-family: 'SF Mono', Menlo, monospace;
  font-size: 12px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
  margin: 0;
  color: var(--text-primary, #e0e0e0);
}
```

---

## Helper Function

```typescript
function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}
```

---

## File Display Order

Files in the tree follow the backend's `KNOWN_SUBFILES` order, minus `meta.json` and `gem.md` (which goes last):

1. `content.md` ‚Äî raw captured content
2. `enrichment.md` ‚Äî AI tags + summary
3. `transcript.md` ‚Äî transcript (recording gems only)
4. `copilot.md` ‚Äî co-pilot analysis (recording gems only)
5. `gem.md` ‚Äî assembled document (the "complete" view)

---

## Edge Cases

| Scenario | Behavior |
|----------|----------|
| Gem has no knowledge files (pre-migration) | Show "No knowledge files" + "Generate" button |
| Knowledge fetch fails | Hide file tree section entirely |
| File deleted between listing and reading | Tab shows "File not found" |
| User switches gems with tabs open | All tabs close, reset to Detail view |
| User clicks same file twice | Switches to existing tab, no duplicate |
| User closes all tabs | Tab bar disappears, returns to single-panel mode |
| `get_gem_knowledge_subfile` returns null | Display "File not found" in the tab content |
